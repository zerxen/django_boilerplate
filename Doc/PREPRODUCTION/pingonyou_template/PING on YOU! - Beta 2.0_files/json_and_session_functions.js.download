//
// pingonyou functional scripts
//

//
// HELPING FUNCTIONS
//
function isAgreeChecked(function_name){
  // function_name can be for examle "ping";
  var checkboxname = function_name + '-agree-checkbox';
  if (document.getElementById(checkboxname).checked){
    return true;
  }
  return false;
}

function isTargetEmpty(function_name){
  // function_name can be for examle "ping";
  var inputname = function_name + '-target';
  var input = document.getElementById(inputname).value;
  if (input==null || input==""){
    return true;
  }
  return false;
}

function closeAllClientFunctionContainers(){
  $('#client_ping-results-container').slideUp("fast");
  $('#client_whois-results-container').slideUp("fast");
  $('#client_nslookup-results-container').slideUp("fast");
}  


function alert_policy_not_agreed(){
  alert("You have not agreed to our Anti-DoS policy! Please read about the limits and anti-dos policy following the link near the checkbox below input and once understood use the checkbox. Thanks!");
}

//
// SECTION I - adding events to HTML elements
// 

// PING INITIATION ACTION
$(document).ready(function() {
  $('#ping-submit').click(function(event) {
      if (!isAgreeChecked("ping")){
        alert_policy_not_agreed();
        return;
      }   
      if (isTargetEmpty("ping")){
        alert("You have not entered a valid target!");
        return;
      }            
      $('#quick-ping-features').slideUp("fast");
      event.preventDefault();
      var target = document.getElementById("ping-target").value;
      var arr = { action: 'ping', target: target };
      init_ajax(arr,'ping');
  });
});

// nslookup INITIATION ACTION
$(document).ready(function() {
  $('#nslookup-submit').click(function(event) {
      event.preventDefault();
      if (!isAgreeChecked("nslookup")){
        alert_policy_not_agreed();
        return;
      }   
      if (isTargetEmpty("nslookup")){
        alert("You have not entered a valid target!");
        return;
      }            
      var target = document.getElementById("nslookup-target").value;
      var arr = { action: 'nslookup', target: target };
      init_ajax(arr);
  });
});
// whois INITIATION ACTION
$(document).ready(function() {
  $('#whois-submit').click(function(event) {
      event.preventDefault();
      if (!isAgreeChecked("whois")){
        alert_policy_not_agreed();
        return;
      }   
      if (isTargetEmpty("whois")){
        alert("You have not entered a valid target!");
        return;
      }        
      var target = document.getElementById("whois-target").value;
      var arr = { action: 'whois', target: target };
      init_ajax(arr);
  });
});
// wget INITIATION ACTION
$(document).ready(function() {
  $('#wget-submit').click(function(event) {
      event.preventDefault();
      if (!isAgreeChecked("wget")){
        alert_policy_not_agreed();
        return;
      }   
      if (isTargetEmpty("wget")){
        alert("You have not entered a valid target!");
        return;
      }           
      var target = document.getElementById("wget-target").value;
      var arr = { action: 'wget', target: target };
      init_ajax(arr);
  });
});
// ssh INITIATION ACTION
$(document).ready(function() {
  $('#ssh-submit').click(function(event) {
      event.preventDefault();
      if (!isAgreeChecked("ssh")){
        alert_policy_not_agreed();
        return;
      }   
      if (isTargetEmpty("ssh")){
        alert("You have not entered a valid target!");
        return;
      }             
      var target = document.getElementById("ssh-target").value;
      var arr = { action: 'ssh', target: target };
      init_ajax(arr);
  });
});

// client_whois INITIATION ACTION
$(document).ready(function() {
  $('#client_ping-submit').click(function(event) {
      event.preventDefault();
      
      // VISUALS
      closeAllClientFunctionContainers();
      $('#client_ping-results-container').slideDown("fast");
      
      var target = document.getElementById("client_ping-target").value;
      var arr = { action: 'client_ping', target: target };
      init_ajax(arr);
  });
});

// client_nslookup INITIATION ACTION
$(document).ready(function() {
  $('#client_nslookup-submit').click(function(event) {
      event.preventDefault();
      
      // VISUALS
      closeAllClientFunctionContainers();      
      $('#client_nslookup-results-container').slideDown("fast");
      
      var target = document.getElementById("client_nslookup-target").value;
      var arr = { action: 'client_nslookup', target: target };
      init_ajax(arr);
  });
});
// client_whois INITIATION ACTION
$(document).ready(function() {
  $('#client_whois-submit').click(function(event) {
      event.preventDefault();
      
      // VISUALS
      closeAllClientFunctionContainers();      
      $('#client_whois-results-container').slideDown("fast");
      
      var target = document.getElementById("client_whois-target").value;
      var arr = { action: 'client_whois', target: target };
      init_ajax(arr);
  });
});


// GETTING CLIENT IP TO ALL FIELDS
$(document).ready(function() {
  init_get_client_IP_action();
});


//
// SECTION II - initiating AJAX requests
//
function init_ajax(json_string) {    
    $.ajax({
        url:          "./cgi-bin/execution_skeleton.cgi",
        type:         'POST',
        cache:        false,
        contentType:  'application/json; charset=utf-8',
        dataType:     'json',
        data:         JSON.stringify(json_string),
        success:      function(result,statusText, xhr) { read_session_result(result); },
        error:        function(xhr,textStatus,errorThrown) {             
            //alert("Handle Errors here, code:"+ xhr.status + " textStatus:" + textStatus + " errorThrown" + errorThrown);
            if ((xhr.status == 200) && (textStatus === "parsererror") ){
              init_ajax(json_string);  
            }else{
              alert("AJAX initialization failed. We will re-try for you, but if this message repeats there is a problem with your browser.");
              init_ajax(json_string);
            } 
        },
        complete:     function(result,statusText, xhr) { }        
        
    });
}


//
// SECTION III - reading sessions on running functions
//

// FUNCTION ITSELF
function read_session_result(result){
    //alert("action: " + result.action);
    var action = result.action;
    if (action == null)
    {     
      alert("ERROR: "+ result.error);
      return;
    }
    
    $('#'+action+'-data').html(result.data);
    $('#'+action+'-error').html(result.error);
    $('#'+action+'-status').html(result.status);
    $('#'+action+'-session').html(result.session);    
    
    // VISUAL: OPENS THE RESULTS WINDOW
    $('#'+action+'-results').slideDown("fast");
    
    
    // QUICK WARNING ON OLD RESULTS FOR THE USER
    var minutes_age = result.age / 60;
    
    if (minutes_age < 0.1){
      $('#'+action+'-age').html("LIVE");
    }else{
      $('#'+action+'-age').html("<font color=\"red\">Cached: " + minutes_age.toFixed(0) + " minutes</font>");
    }
    
    if (minutes_age >= 5 && result.status != "init"){
      alert("Warning : Server indicated that the results are from cache either because of anti-DoS policy or server has problems. Age of the data is: " + minutes_age.toFixed(0) + " minutes");
    } 
    
    // INITIATES READING SESSION, OR SSH SESSIONS
    if ( (result.status == "init" || result.status == "running"))
    {
      setTimeout( function() { read_session(result.session) } , 1000);           
    }
    else if ( result.status == "ssh_init" )
    {
        if (minutes_age >= 5){
            alert("SSH preparation is stuck on server side, the SSH initialization is more than 5 minutes old!");
        }else{
            goNewSSHWin(result.session);
        }           
    }        
    
    // VISUAL: HIDES/SHOWS SUBMIT BUTTON TO AVOID RE-SUBMITTING DURING RUN
    if (  result.status == "init" ||  result.status == "running"){
      document.getElementById('#'+action+"-target").disabled = true;
      document.getElementById('#'+action+"-submit").disabled = true;
      //$("#ping-submit").slideUp("fast");
    }
    else
    {
      //$("#ping-submit").slideDown("fast");
      document.getElementById('#'+action+"-submit").disabled = false;
      document.getElementById('#'+action+"-target").disabled = false;
    } 
    

             

}

function read_session(session){
    var arr = { session: session };
    $.ajax({
        url:          "./cgi-bin/execution_skeleton.cgi",
        type:         'POST',
        cache:        false,
        contentType:  'application/json; charset=utf-8',
        dataType:     'json',
        data:         JSON.stringify(arr),        
        success:      function(result) {read_session_result(result); },
        error:        function(xhr,textStatus,errorThrown) {             
            //alert("Handle Errors here, code:"+ xhr.status + " textStatus:" + textStatus + " errorThrown" + errorThrown);
            if ((xhr.status == 200) && (textStatus === "parsererror") ){
              read_session(session);  
            }else if(xhr.status == 0){ 
              read_session(session);  
            }else{
              alert("AJAX failed to return session data back to us.");
            } 
        },
        complete:     function(result) { }        
        
    });
}




//
// SSH - INITIALIZATION
//

function goNewSSHWin(session){
  var NewWinHeight=800;
  var NewWinWidth=600;
  var NewWinPutX=100; 
  var NewWinPutY=100;
  var url = "./cgi-bin/ssh.cgi?session=" + session;
  TheNewWin =window.open(url,'TheNewpop','fullscreen=yes,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no');
  TheNewWin.resizeTo(NewWinHeight,NewWinWidth);
  TheNewWin.moveTo(NewWinPutX,NewWinPutY);  
}


//
// Getting client IP to static HTML forms
//

function init_get_client_IP_action() {
    var arr = { action: 'get_client_IP'};
    $.ajax({
        url:          "./cgi-bin/get_client_IP.cgi",
        type:         'POST',
        cache:        false,
        contentType:  'application/json; charset=utf-8',
        dataType:     'json',
        data:         JSON.stringify(arr),
        success:      function(result,statusText, xhr) { push_client_IP_to_fields(result); },
        //error:        function(xhr,textStatus,errorThrown) { alert("get Client IP initialization failed.") },
        error:        function(xhr,textStatus,errorThrown) { },
        complete:     function(result,statusText, xhr) { }        
        
    });
}


function push_client_IP_to_fields(result) {
    //$('#data').html("IP: " + result.ip + " version:" + result.version);
    //$('#error').html("Get Client IP results");
    //$('#status').html("Get Client IP results");
    //$('#session').html("no session");
    
    //$('#client_nslookup-target').html(result.ip);
    document.getElementById("client_nslookup-target").value = result.ip;
    
    //$('#client_whois-target').html(result.ip);
    document.getElementById("client_whois-target").value = result.ip;
    
    document.getElementById("client_ping-target").value = result.ip;
    
    //document.getElementById("client-IP-box") = result.ip;
    $('#client-IP-box').html(result.ip);
    
    $('#client_ip_dependent_functions').slideDown("fast");
}

